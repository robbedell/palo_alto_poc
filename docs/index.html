<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palo Alto Firewall Automation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark-mode {
            background-color: #121212;
            color: #f4f4f4;
        }
        header {
            background-color: #0078d7;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        main {
            padding: 2rem;
            max-width: 800px;
            margin: auto;
        }
        label {
            font-weight: bold;
        }
        input, button {
            margin: 0.5rem 0;
            padding: 0.5rem;
            width: 100%;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #0078d7;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #005bb5;
        }
        .row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .row input {
            flex: 1;
        }
        .dark-mode button {
            background-color: #333;
            color: white;
        }
        .dark-mode button:hover {
            background-color: #555;
        }
        .toggle-dark-mode {
            margin-top: 1rem;
            cursor: pointer;
            text-align: center;
        }
        .error {
            color: red;
            font-size: 0.9rem;
        }
    </style>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function validateInput(input, regex, errorMessage) {
            const errorElement = input.nextElementSibling;
            if (!regex.test(input.value)) {
                errorElement.textContent = errorMessage;
                return false;
            }
            errorElement.textContent = '';
            return true;
        }

        function addCustomRow(containerId, fields) {
            const container = document.getElementById(containerId);
            const row = document.createElement("div");
            row.className = "row";
            fields.forEach(field => {
                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = field.placeholder;
                input.className = field.className;
                input.required = field.required || false;
                input.oninput = () => validateInput(input, field.regex, field.errorMessage);
                row.appendChild(input);

                const error = document.createElement("div");
                error.className = "error";
                row.appendChild(error);
            });
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.textContent = "Remove";
            removeButton.onclick = () => row.remove();
            row.appendChild(removeButton);
            container.appendChild(row);
        }

        function generateScripts() {
            const firewallIp = document.getElementById("firewallIp");
            const apiKey = document.getElementById("apiKey");

            if (!validateInput(firewallIp, /^\d{1,3}(\.\d{1,3}){3}$/, "Invalid IP address") ||
                !validateInput(apiKey, /^[a-zA-Z0-9]+$/, "Invalid API key")) {
                alert("Please fix the errors before generating scripts.");
                return;
            }

            const customIps = [];
            document.querySelectorAll(".custom-ip-row").forEach(row => {
                const interfaceName = row.querySelector(".interface-name").value;
                const ip = row.querySelector(".ip-address").value;
                const subnet = row.querySelector(".subnet-mask").value;

                if (interfaceName && ip && subnet) {
                    customIps.push({ interfaceName, ip, subnet });
                }
            });

            const customAddresses = [];
            document.querySelectorAll(".custom-address-row").forEach(row => {
                const name = row.querySelector(".address-name").value;
                const ip = row.querySelector(".address-ip").value;
                const description = row.querySelector(".address-description").value;

                if (name && ip) {
                    customAddresses.push({ name, ip, description });
                }
            });

            const customServices = [];
            document.querySelectorAll(".custom-service-row").forEach(row => {
                const name = row.querySelector(".service-name").value;
                const protocol = row.querySelector(".service-protocol").value;
                const port = row.querySelector(".service-port").value;
                const description = row.querySelector(".service-description").value;

                if (name && protocol && port) {
                    customServices.push({ name, protocol, port, description });
                }
            });

            if (!firewallIp || !apiKey) {
                alert("Please provide all required inputs.");
                return;
            }

            const pythonScript = `
import requests
import xml.etree.ElementTree as ET
import logging

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Palo Alto Firewall details
firewall_ip = '${firewallIp.value}'
api_key = '${apiKey.value}'

custom_ips = {
${customIps.map(ip => `    "${ip.interfaceName}": {"ip": "${ip.ip}", "subnet": "${ip.subnet}"}`).join(",\n")}
}

# Function to send requests to the firewall
def send_request(endpoint, params):
    url = f"https://{firewall_ip}/api/"
    params['key'] = api_key
    try:
        response = requests.get(url, params=params, verify=False)
        response.raise_for_status()  # Raise HTTPError for bad responses
        return response.text
    except requests.exceptions.RequestException as e:
        logging.error(f"Request to {url} failed: {e}")
        return None

# Function to check response success
def is_success(response):
    if response and 'success' in response:
        return True
    return False

# Configure interfaces 1-4 as Layer 3 with DHCP
def configure_interfaces(custom_ips=None):
    for interface_id in range(1, 5):
        interface_name = f'ethernet1/{interface_id}'
        logging.info(f"Configuring interface {interface_name}...")

        # Set interface to Layer 3
        set_interface_url = f"/config/devices/entry[@name='localhost.localdomain']/network/interface/ethernet/entry[@name='{interface_name}']/layer3"
        set_interface_params = {
            'type': 'config',
            'action': 'set',
            'xpath': set_interface_url,
            'element': '<layer3><interface>layer3</interface><dhcp-client><create-default-route>no</create-default-route></dhcp-client></layer3>'
        }

        # Enable DHCP client
        dhcp_client_url = f"{set_interface_url}/dhcp-client"
        dhcp_client_params = {
            'type': 'config',
            'action': 'set',
            'xpath': dhcp_client_url,
            'element': '<dhcp-client><enable>yes</enable></dhcp-client>'
        }

        # Sending requests to configure the interface
        response_set = send_request(set_interface_url, set_interface_params)
        response_dhcp = send_request(dhcp_client_url, dhcp_client_params)

        # Check for success
        if is_success(response_set) and is_success(response_dhcp):
            logging.info(f"Interface {interface_name} configured successfully.")
        else:
            logging.error(f"Failed to configure Interface {interface_name}.")

# Add virtual routers
def add_virtual_routers():
    virtual_routers = ['trust', 'untrust', 'vpn', 'webtier']
    for vr_name in virtual_routers:
        logging.info(f"Adding virtual router {vr_name}...")
        vr_xpath = f"/config/devices/entry[@name='localhost.localdomain']/network/virtual-router/entry[@name='{vr_name}']"
        vr_element = f"<entry name='{vr_name}'></entry>"
        vr_params = {
            'type': 'config',
            'action': 'set',
            'xpath': vr_xpath,
            'element': vr_element
        }

        # Sending request to add the virtual router
        response_vr = send_request(vr_xpath, vr_params)

        # Check for success
        if is_success(response_vr):
            logging.info(f"Virtual router {vr_name} added successfully.")
        else:
            logging.error(f"Failed to add virtual router {vr_name}.")

# Add POC Any/Any security policy for testing
def add_security_policy():
    policy_name = "POC_Any_Any_premigrate"
    logging.info(f"Adding security policy {policy_name}...")
    policy_xpath = f"/config/devices/entry[@name='localhost.localdomain']/rulebase/security/rules/entry[@name='{policy_name}']"
    policy_element = f"""
    <entry name="{policy_name}">
        <from><member>any</member></from>
        <to><member>any</member></to>
        <source><member>any</member></source>
        <destination><member>any</member></destination>
        <service><member>any</member></service>
        <application><member>any</member></application>
        <action>allow</action>
        <tag><member>POC-DELETE</member></tag>
    </entry>
    """
    policy_params = {
        'type': 'config',
        'action': 'set',
        'xpath': policy_xpath,
        'element': policy_element
    }

    # Sending request to add the policy
    response_policy = send_request(policy_xpath, policy_params)

    # Check for success
    if is_success(response_policy):
        logging.info(f"Policy {policy_name} added successfully.")
    else:
        logging.error(f"Failed to add policy {policy_name}.")

# Main execution
if __name__ == "__main__":
    logging.info("Starting configuration...")
    configure_interfaces(custom_ips=custom_ips)
    add_virtual_routers()
    add_security_policy()
    logging.info("Configuration completed.")
            `;

            const terraformScript = `
provider "panos" {
  hostname = "${firewallIp.value}"
  api_key  = "${apiKey.value}"
}

resource "panos_interface" "ethernet" {
  for_each = toset(["ethernet1/1", "ethernet1/2", "ethernet1/3", "ethernet1/4"])

  name = each.key
  mode = "layer3"

  dynamic "ip" {
    for_each = lookup({
${customIps.map(ip => `      "${ip.interfaceName}" = { ip = "${ip.ip}", subnet = "${ip.subnet}" }`).join(",\n")}
    }, each.key, {})

    content {
      address = "${ip.value.ip}/${ip.value.subnet}"
    }
  }

  dhcp_client {
    enable = ip.value == null
    create_default_route = false
  }
}

resource "panos_virtual_router" "routers" {
  for_each = toset(["trust", "untrust", "vpn", "webtier"])

  name = each.key
}

resource "panos_security_rule" "poc_any_any" {
  name          = "POC_Any_Any_premigrate"
  from_zones    = ["any"]
  to_zones      = ["any"]
  source_addresses = ["any"]
  destination_addresses = ["any"]
  applications  = ["any"]
  services      = ["any"]
  action        = "allow"
  tags          = ["POC-DELETE"]
}

resource "panos_address_object" "custom_addresses" {
  for_each = {
${customAddresses.map(addr => `    "${addr.name}" = { ip = "${addr.ip}", description = "${addr.description}" }`).join(",\n")}
  }

  name        = each.key
  value       = each.value.ip
  description = each.value.description
}

resource "panos_service_object" "custom_services" {
  for_each = {
${customServices.map(svc => `    "${svc.name}" = { protocol = "${svc.protocol}", port = "${svc.port}", description = "${svc.description}" }`).join(",\n")}
  }

  name        = each.key
  protocol    = each.value.protocol
  destination_port = each.value.port
  description = each.value.description
}
            `;

            const ansiblePlaybook = `
- name: Configure Palo Alto Firewall
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Configure interfaces
      panos_interface:
        provider:
          ip_address: "${firewallIp.value}"
          api_key: "${apiKey.value}"
        name: "{{ item.name }}"
        mode: "layer3"
        ip: "{{ item.ip }}"
        dhcp_client:
          enable: "{{ item.dhcp }}"
          create_default_route: false
      loop:
${customIps.map(ip => `        - { name: "${ip.interfaceName}", ip: "${ip.ip}/${ip.subnet}", dhcp: false }`).join("\n")}
        - { name: "ethernet1/3", ip: null, dhcp: true }
        - { name: "ethernet1/4", ip: null, dhcp: true }

    - name: Add virtual routers
      panos_virtual_router:
        provider:
          ip_address: "${firewallIp.value}"
          api_key: "${apiKey.value}"
        name: "{{ item }}"
      loop:
        - "trust"
        - "untrust"
        - "vpn"
        - "webtier"

    - name: Add security policy
      panos_security_rule:
        provider:
          ip_address: "${firewallIp.value}"
          api_key: "${apiKey.value}"
        rule_name: "POC_Any_Any_premigrate"
        from_zone: ["any"]
        to_zone: ["any"]
        source: ["any"]
        destination: ["any"]
        application: ["any"]
        service: ["any"]
        action: "allow"
        tag: ["POC-DELETE"]
            `;

            downloadFile("east-fw-config.py", pythonScript);
            downloadFile("palo_alto_firewall.tf", terraformScript);
            downloadFile("ansible_playbook.yml", ansiblePlaybook);
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
    </script>
</head>
<body>
    <header>
        <h1>Palo Alto Firewall Automation</h1>
    </header>
    <main>
        <p>Use this tool to generate Python, Terraform, and Ansible scripts for automating Palo Alto Firewall configurations. Fill in the required fields below and click "Generate Scripts".</p>
        <form onsubmit="event.preventDefault(); generateScripts();">
            <label for="firewallIp">Firewall Management IP:</label>
            <input type="text" id="firewallIp" placeholder="e.g., 192.168.1.1" required>
            <div class="error"></div>

            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" placeholder="Enter your API key" required>
            <div class="error"></div>

            <h3>Custom Interface Configuration</h3>
            <div id="customIpContainer"></div>
            <button type="button" onclick="addCustomRow('customIpContainer', [
                { placeholder: 'Interface Name (e.g., ethernet1/1)', className: 'interface-name', regex: /^ethernet\d+\/\d+$/, errorMessage: 'Invalid interface name', required: true },
                { placeholder: 'IP Address (e.g., 192.168.10.1)', className: 'ip-address', regex: /^\d{1,3}(\.\d{1,3}){3}$/, errorMessage: 'Invalid IP address', required: true },
                { placeholder: 'Subnet Mask (e.g., 24)', className: 'subnet-mask', regex: /^\d{1,2}$/, errorMessage: 'Invalid subnet mask', required: true }
            ])">Add Interface</button>

            <h3>Custom Address Objects</h3>
            <div id="customAddressContainer"></div>
            <button type="button" onclick="addCustomRow('customAddressContainer', [
                { placeholder: 'Address Name (e.g., web_server)', className: 'address-name', regex: /^[a-zA-Z0-9_]+$/, errorMessage: 'Invalid name', required: true },
                { placeholder: 'IP Address (e.g., 192.168.30.10)', className: 'address-ip', regex: /^\d{1,3}(\.\d{1,3}){3}$/, errorMessage: 'Invalid IP address', required: true },
                { placeholder: 'Description (e.g., Web Server)', className: 'address-description', regex: /^.*$/, errorMessage: '' }
            ])">Add Address</button>

            <h3>Custom Service Objects</h3>
            <div id="customServiceContainer"></div>
            <button type="button" onclick="addCustomRow('customServiceContainer', [
                { placeholder: 'Service Name (e.g., http)', className: 'service-name', regex: /^[a-zA-Z0-9_]+$/, errorMessage: 'Invalid name', required: true },
                { placeholder: 'Protocol (e.g., tcp)', className: 'service-protocol', regex: /^(tcp|udp)$/, errorMessage: 'Invalid protocol', required: true },
                { placeholder: 'Port (e.g., 80)', className: 'service-port', regex: /^\d+$/, errorMessage: 'Invalid port', required: true },
                { placeholder: 'Description (e.g., HTTP Service)', className: 'service-description', regex: /^.*$/, errorMessage: '' }
            ])">Add Service</button>

            <button type="submit">Generate Scripts</button>
        </form>
        <div class="toggle-dark-mode">
            <button type="button" onclick="toggleDarkMode()">Toggle Dark Mode</button>
        </div>
    </main>
</body>
</html>